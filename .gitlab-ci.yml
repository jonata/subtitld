staging:amd64:
  image:
    name: ubuntu:16.04
  type: deploy
  script:
  - apt-get update -qy
  - apt-get install -y software-properties-common wget build-essential
  - add-apt-repository -y ppa:deadsnakes/ppa
  - apt-get update -qy
  - apt-get install -y python3.7 python3.7-dev gnupg snapcraft ghostscript
  - wget https://bootstrap.pypa.io/get-pip.py
  - python3.7 get-pip.py
  - python3.7 -m pip install -r requirements.txt
  - python3.7 -m PyInstaller subtitld_linux.spec
  - mv dist .dist
  - mv snap .snap
  - mv snapcraft.yaml .snapcraft.yaml
  - mv * /tmp/
  - mv .dist dist
  - mv .snap snap
  - mv .snapcraft.yaml snapcraft.yaml
  - snapcraft
  - echo $SNAPCRAFT_LOGIN_FILE | base64 --decode --ignore-garbage > snapcraft.login
  - snapcraft login --with snapcraft.login
  - snapcraft push *.snap --release beta
  only:
  - master

windows-nsis:
  image: schnouki/pyinstaller-windows-ci:python3
  type: deploy
  script:
  - apt-get update -qy
  - apt-get install -y nsis unzip openssh-client sshpass p7zip-full
  - wget 'https://raw.githubusercontent.com/Winetricks/winetricks/master/src/winetricks'
  - chmod +x winetricks
  - ./winetricks -q dotnet46
  - wget https://aka.ms/vs/15/release/vs_buildtools.exe
  - wine vs_buildtools.exe --quiet --wait --norestart --nocache
  - wine pip3 install -r requirements.txt
  - wget https://ffmpeg.zeranoe.com/builds/win64/static/ffmpeg-latest-win64-static.zip
  - unzip ffmpeg-latest-win64-static.zip
  - wget https://mpv.srsfckn.biz/mpv-dev-latest.7z
  - 7z x -ompv mpv-dev-latest.7z
  - wine pyinstaller subtitld_win.spec
  - makensis subtitld_win.nsi
  - export SSHPASS=$USER_PASS
  - sshpass -e scp -o stricthostkeychecking=no Subtitld*Installer.exe jonata@jonata.org:/home/jonata/subtitld.jonata.org/packages/
  artifacts:
    paths:
    - Subtitld*Installer.exe
    expire_in: 1 week
  only:
  - master
