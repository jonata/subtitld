snap-edge:amd64:
  image:
    name: ubuntudesktop/gnome-3-38-2004:latest
  stage: deploy
  script:
    - export VERSION_NUMBER=`date +%y.%m.%d.%H%M`
    - apt-get update
    - apt-get install -y python3-dev
    - snapcraft
    - echo ${SNAPCRAFT_LOGIN_FILE} | base64 --decode --ignore-garbage > snapcraft.login
    - snapcraft login --with snapcraft.login
    - snapcraft upload *.snap --release edge
  artifacts:
    paths:
      - subtitld*.snap
    expire_in: 1 week
  only:
    - master

appimage:
  image:
    name: ubuntu:jammy
  stage: deploy
  before_script:
    - DEBIAN_FRONTEND=noninteractive apt update
  script:
    - export VERSION_NUMBER=`date +%y.%m.%d.%H%M`
    - apt-get update -qy
    - apt-get install -y sshpass
    - DEBIAN_FRONTEND=noninteractive apt-get install -y wget python3-pip gtk-update-icon-cache libgdk-pixbuf-2.0-0 squashfs-tools zsync libglib2.0-bin
    - mkdir -p ~/.local/bin
    - wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O ~/.local/bin/appimagetool
    - chmod +x ~/.local/bin/appimagetool
    - python3 --version
    - python3 -m pip install appimage-builder
    - appimage-builder --skip-test --recipe AppImageBuilder.yml
    - ls
    - mv Subtitld*.AppImage "Subtitld ${VERSION_NUMBER}.AppImage"
    - export SSHPASS=$USER_PASS
    - sshpass -e scp -o stricthostkeychecking=no Subtitld*.AppImage jonata@jonata.org:/home/jonata/builds.subtitld.org/appimage/
  artifacts:
    paths:
      - '*.AppImage*'
    expire_in: 1 week

windows:
  image: cheaterman/pyinstaller-windows:latest
  stage: deploy
  script:
    - export VERSION_NUMBER=`date +%y.%m.%d.%H%M`
    - apt-get update -qy
    - apt-get install -y nsis openssh-client sshpass unzip librsvg2-bin
    - wget https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip --no-check-certificate
    - unzip ffmpeg-release-essentials.zip
    - wine pip3 install -r requirements.txt
    - wine pip3 install -U pyinstaller glfw pywin32
    - for f in subtitld/graphics/*.svg; do rsvg-convert "$f" -o "${f%.*}.png"; done
    - sed -i 's/.svg/.png/g' subtitld/graphics/stylesheet.qss
    - sed -i 's/.svg/.png/g' subtitld/resources.qrc
    - rm subtitld/resources_rc.py
    - wine 'c:/python39/Scripts/pyside6-rcc.exe' subtitld/resources.qrc -o subtitld/resources_rc.py
    - wine pyinstaller subtitld_win.spec
    - makensis subtitld_win.nsi
    - mv "dist/Subtitld Portable.exe" "Subtitld ${VERSION_NUMBER} Portable.exe"
    - export SSHPASS=$USER_PASS
    - sshpass -e scp -o stricthostkeychecking=no Subtitld*.exe jonata@jonata.org:/home/jonata/builds.subtitld.org/windows/
  artifacts:
    paths:
      - Subtitld*.exe
    expire_in: 1 week
  only:
    - master
