staging:amd64:
  image:
    name: ubuntu:18.04
  type: deploy
  script:
  - apt-get update -qy
  - apt-get install -y software-properties-common wget unzip
  - add-apt-repository -y ppa:mc3man/mpv-tests
  - cp /etc/apt/sources.list /etc/apt/sources.list~
  - sed -Ei 's/^# deb-src /deb-src /' /etc/apt/sources.list
  - apt-get update -qy
  - apt-get install -y python3-pip libglu1-mesa snapcraft
  #libluajit-5.1-dev libass-dev libbluray-dev libuchardet-dev librubberband-dev libarchive-dev libavcodec-dev
  - apt-get build-dep -y mpv
  - wget https://github.com/mpv-player/mpv/archive/v0.32.0.zip
  - unzip v0.32.0.zip
  - ./mpv-0.32.0/bootstrap.py
  - ./mpv-0.32.0/waf configure
  - ./mpv-0.32.0/waf
  - ./mpv-0.32.0/waf install
  - python3 -m pip install --upgrade pip
  - python3 -m pip install -r requirements.txt
  - python3 -m pip install https://github.com/pyinstaller/pyinstaller/archive/develop.zip
  - python3 -m PyInstaller subtitld_linux.spec
  - mv dist .dist
  - mv snap .snap
  - mv snapcraft.yaml .snapcraft.yaml
  - mv * /tmp/
  - mv .dist dist
  - mv .snap snap
  - mv .snapcraft.yaml snapcraft.yaml
  - snapcraft
  - echo $SNAPCRAFT_LOGIN_FILE | base64 --decode --ignore-garbage > snapcraft.login
  - snapcraft login --with snapcraft.login
  - snapcraft push *.snap --release beta
  artifacts:
    paths:
    - dist
    expire_in: 1 week
  only:
  - master

windows-nsis:
  image: schnouki/pyinstaller-windows-ci:python3
  type: deploy
  script:
  - apt-get update -qy
  - apt-get install -y nsis unzip openssh-client sshpass p7zip-full
  - wine pip3 install -r requirements.txt
  - wget https://ffmpeg.zeranoe.com/builds/win64/static/ffmpeg-latest-win64-static.zip
  - unzip ffmpeg-latest-win64-static.zip
  - wget https://mpv.srsfckn.biz/mpv-dev-latest.7z
  - 7z x -ompv mpv-dev-latest.7z
  - wine pyinstaller subtitld_win.spec
  - makensis subtitld_win.nsi
  - export SSHPASS=$USER_PASS
  - sshpass -e scp -o stricthostkeychecking=no Subtitld*Installer.exe jonata@jonata.org:/home/jonata/subtitld.jonata.org/packages/
  artifacts:
    paths:
    - Subtitld*Installer.exe
    expire_in: 1 week
  only:
  - master
